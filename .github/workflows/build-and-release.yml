name: Build, Test and Release

on:
    workflow_dispatch:
        inputs:
            push_to_nuget:
                description: "Push packages to NuGet.org (ensure version is correct)"
                required: true
                type: boolean
                default: false
            create_release:
                description: "Create GitHub Release and Git Tag"
                required: true
                type: boolean
                default: false
            version_tag:
                description: "Version tag (e.g., v1.0.0)"
                required: true
                type: string

# Prevent concurrent releases
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# Explicit permissions for security
permissions:
    contents: write # For creating releases and tags
    pull-requests: write # For PR comments
    actions: read
    checks: write

env:
    DOTNET_VERSION: "10.0.x"
    BUILD_CONFIGURATION: "Release"
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
    DOTNET_CLI_TELEMETRY_OPTOUT: true
    NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for proper versioning

            - name: Validate version tag
              if: github.event.inputs.create_release == 'true'
              run: |
                  if [ -z "${{ github.event.inputs.version_tag }}" ]; then
                    echo "Error: version_tag is required when create_release is true"
                    exit 1
                  fi
                  if [[ ! "${{ github.event.inputs.version_tag }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "Error: version_tag must match pattern v*.*.* (e.g., v1.0.0)"
                    exit 1
                  fi

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            # Cache NuGet packages for faster builds
            - name: Cache NuGet packages
              uses: actions/cache@v4
              with:
                  path: ${{ env.NUGET_PACKAGES }}
                  key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props') }}
                  restore-keys: |
                      ${{ runner.os }}-nuget-

            - name: Restore dependencies
              run: dotnet restore

            - name: Build
              run: dotnet build MiCake.All.sln --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

            - name: Run tests with coverage
              run: |
                  dotnet test MiCake.All.sln \
                    --configuration ${{ env.BUILD_CONFIGURATION }} \
                    --no-build \
                    --settings src/tests/runsettings.xml \
                    --collect:"XPlat Code Coverage" \
                    --results-directory ./coverage \
                    -- RunConfiguration.DisableAppDomain=true

            - name: Generate coverage report
              run: |
                  dotnet tool install --global dotnet-reportgenerator-globaltool
                  reportgenerator \
                    -reports:./coverage/**/coverage.cobertura.xml \
                    -targetdir:./coverlet/reports \
                    -reporttypes:"Cobertura;HtmlInline_AzurePipelines"

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: ./coverage/**/coverage.cobertura.xml
                  flags: unittests
                  fail_ci_if_error: false
                  verbose: true
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

            - name: Upload coverage report as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: ./coverlet/reports
                  retention-days: 30

            # Package and publish to NuGet
            - name: Pack NuGet packages
              if: github.event.inputs.push_to_nuget == 'true'
              run: |
                  dotnet pack src/framework/**/*.csproj \
                    --configuration ${{ env.BUILD_CONFIGURATION }} \
                    --no-build \
                    --include-symbols \
                    --include-source \
                    -p:SymbolPackageFormat=snupkg \
                    --output ./artifacts

            - name: Push to NuGet.org
              if: github.event.inputs.push_to_nuget == 'true'
              run: |
                  for package in ./artifacts/*.nupkg; do
                    echo "Pushing $package..."
                    dotnet nuget push "$package" \
                      --source https://api.nuget.org/v3/index.json \
                      --skip-duplicate
                  done

            - name: Upload NuGet packages as artifacts
              if: github.event.inputs.push_to_nuget == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: nuget-packages
                  path: ./artifacts/*.nupkg
                  retention-days: 90

            # Create Git tag and GitHub Release
            - name: Create Git Tag
              if: github.event.inputs.create_release == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "micake_bot@users.noreply.github.com"
                  git tag -a ${{ github.event.inputs.version_tag }} -m "Release ${{ github.event.inputs.version_tag }}"
                  git push origin ${{ github.event.inputs.version_tag }}

            - name: Create GitHub Release
              if: github.event.inputs.create_release == 'true'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.event.inputs.version_tag }}
                  name: MiCake ${{ github.event.inputs.version_tag }}
                  generate_release_notes: true
                  body: |
                      ## MiCake ${{ github.event.inputs.version_tag }}

                      ### ðŸ“¦ NuGet Packages

                      Install via NuGet:
                      ```bash
                      dotnet add package MiCake --version ${{ github.event.inputs.version_tag }}
                      ```

                      | Package | Version |
                      |---------|---------|
                      | [MiCake](https://www.nuget.org/packages/MiCake/) | ${{ github.event.inputs.version_tag }} |
                      | [MiCake.EntityFrameworkCore](https://www.nuget.org/packages/MiCake.EntityFrameworkCore/) | ${{ github.event.inputs.version_tag }} |
                      | [MiCake.AspNetCore](https://www.nuget.org/packages/MiCake.AspNetCore/) | ${{ github.event.inputs.version_tag }} |

                      ### ðŸ“– Documentation
                      Visit [https://micake.github.io](https://micake.github.io) for full documentation.

                      ---

                  draft: false
                  prerelease: false
                  files: |
                      ./artifacts/*.nupkg
                      ./artifacts/*.snupkg
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
