# 自动审计

MiCake 提供了自动审计功能，可以自动记录实体的创建和修改时间、操作人等信息。

## 审计接口

### IHasCreationTime

记录创建时间：

```csharp
public class Article : AggregateRoot<int>, IHasCreationTime
{
    public string Title { get; private set; }
    public string Content { get; private set; }
    
    // 自动填充
    public DateTime CreatedTime { get; set; }
}
```

### IHasModificationTime

记录修改时间：

```csharp
public class Article : AggregateRoot<int>, IHasCreationTime, IHasModificationTime
{
    public string Title { get; private set; }
    
    // 自动填充
    public DateTime CreatedTime { get; set; }
    public DateTime? ModifiedTime { get; set; }
    
    public void UpdateTitle(string newTitle)
    {
        Title = newTitle;
        // ModifiedTime 会自动更新
    }
}
```

### 完整的审计接口

```csharp
public class Product : AggregateRoot<int>, IHasAudit
{
    public string Name { get; private set; }
    
    // 创建信息
    public DateTime CreatedTime { get; set; }
    public int? CreatedBy { get; set; }
    
    // 修改信息
    public DateTime? ModifiedTime { get; set; }
    public int? ModifiedBy { get; set; }
}
```

## 启用审计

### 在配置中启用

```csharp
services.AddMiCakeWithDefault<MyAppModule, MyDbContext>(options =>
{
    options.AuditConfig = audit =>
    {
        audit.Enable = true;  // 启用审计
    };
}).Build();
```

### DbContext 配置

```csharp
public class MyDbContext : MiCakeDbContext
{
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // 必须调用基类方法以应用审计配置
        base.OnModelCreating(modelBuilder);
        
        // 自定义配置
    }
}
```

## 自动填充

当保存实体时，审计字段会自动填充：

```csharp
// 创建实体
var article = new Article { Title = "My Article" };
await _articleRepository.AddAsync(article);
await _articleRepository.SaveChangesAsync();
// CreatedTime 自动设置为当前时间

// 更新实体
article.UpdateTitle("New Title");
await _articleRepository.UpdateAsync(article);
await _articleRepository.SaveChangesAsync();
// ModifiedTime 自动更新为当前时间
```

## 自定义审计提供者

### 实现审计提供者

```csharp
public class CurrentUserAuditProvider : IAuditProvider
{
    private readonly ICurrentUser _currentUser;
    
    public CurrentUserAuditProvider(ICurrentUser currentUser)
    {
        _currentUser = currentUser;
    }
    
    public void SetCreationAuditProperties(object entity)
    {
        if (entity is IHasCreationTime hasCreation)
        {
            hasCreation.CreatedTime = DateTime.UtcNow;
        }
        
        if (entity is IHasCreationUser hasCreationUser)
        {
            hasCreationUser.CreatedBy = _currentUser.Id;
        }
    }
    
    public void SetModificationAuditProperties(object entity)
    {
        if (entity is IHasModificationTime hasModification)
        {
            hasModification.ModifiedTime = DateTime.UtcNow;
        }
        
        if (entity is IHasModificationUser hasModificationUser)
        {
            hasModificationUser.ModifiedBy = _currentUser.Id;
        }
    }
}
```

### 注册审计提供者

```csharp
public class MyAppModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        context.Services.AddScoped<IAuditProvider, CurrentUserAuditProvider>();
        base.ConfigureServices(context);
    }
}
```

## 审计查询

```csharp
// 查询最近创建的文章
var recentArticles = await _articleRepository.Query()
    .OrderByDescending(a => a.CreatedTime)
    .Take(10)
    .ToListAsync();

// 查询特定时间范围的修改
var modifiedArticles = await _articleRepository.Query()
    .Where(a => a.ModifiedTime >= startDate && a.ModifiedTime <= endDate)
    .ToListAsync();
```

## 最佳实践

### 1. 为需要审计的实体实现接口

```csharp
// ✅ 需要审计的实体
public class Order : AggregateRoot<int>, IHasCreationTime, IHasModificationTime
{
    public DateTime CreatedTime { get; set; }
    public DateTime? ModifiedTime { get; set; }
}

// 不需要审计的实体可以不实现接口
public class OrderItem : Entity<int>
{
    // 不需要审计字段
}
```

### 2. 使用 UTC 时间

```csharp
public class DefaultTimeAuditProvider : IAuditProvider
{
    public void SetCreationAuditProperties(object entity)
    {
        if (entity is IHasCreationTime hasCreation)
        {
            hasCreation.CreatedTime = DateTime.UtcNow;  // 使用 UTC
        }
    }
}
```

## 小结

MiCake 自动审计：

- 实现审计接口（IHasCreationTime、IHasModificationTime）
- 在 SaveChangesAsync 时自动填充
- 支持自定义审计提供者
- 记录创建和修改信息

下一步：
- 学习[软删除支持](./软删除支持.md)了解逻辑删除
- 查看[仓储](./仓储.md)了解持久化
