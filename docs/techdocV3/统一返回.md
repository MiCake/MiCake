# 统一返回

MiCake 提供了统一的 API 响应格式包装功能，让您的 Web API 返回一致的数据结构。

## 什么是统一返回

统一返回格式将 Controller 的返回值自动包装成标准的响应结构：

```csharp
// Controller 返回
public Product GetProduct(int id)
{
    return new Product { Id = id, Name = "Product A" };
}

// 实际 HTTP 响应
{
  "code": "200",
  "message": "Success",
  "data": {
    "id": 1,
    "name": "Product A"
  }
}
```

## 启用统一返回

### 在 Startup 中配置

```csharp
services.AddMiCakeWithDefault<MyAppModule, MyDbContext>(options =>
{
    options.AspNetConfig = asp =>
    {
        // 启用数据包装器
        asp.UseDataWrapper = true;
        
        // 配置响应选项
        asp.DataWrapperOptions.SuccessCode = "200";
        asp.DataWrapperOptions.SuccessMessage = "Success";
        asp.DataWrapperOptions.ErrorCode = "500";
        asp.DataWrapperOptions.ErrorMessage = "Error";
    };
}).Build();
```

## 响应格式

### 成功响应

```csharp
[HttpGet("{id}")]
public async Task<Product> GetProduct(int id)
{
    return await _productRepository.FindAsync(id);
}

// 响应
{
  "code": "200",
  "message": "Success",
  "data": {
    "id": 1,
    "name": "Product A",
    "price": 99.99
  }
}
```

### 错误响应

```csharp
[HttpPost]
public async Task<Order> CreateOrder(CreateOrderDto dto)
{
    if (dto.Items.Count == 0)
        throw new DomainException("Order must have at least one item");
    
    // ...
}

// 异常时的响应
{
  "code": "500",
  "message": "Order must have at least one item",
  "data": null
}
```

### 集合响应

```csharp
[HttpGet]
public async Task<List<Product>> GetProducts()
{
    return await _productRepository.Query().ToListAsync();
}

// 响应
{
  "code": "200",
  "message": "Success",
  "data": [
    { "id": 1, "name": "Product A" },
    { "id": 2, "name": "Product B" }
  ]
}
```

## 自定义响应格式

### 自定义成功响应

```csharp
public class CustomApiResponse<T> : IResponseWrapper
{
    public bool Success { get; set; }
    public string Message { get; set; }
    public T Data { get; set; }
    public DateTime Timestamp { get; set; }
    
    public CustomApiResponse(T data, string message = "Success")
    {
        Success = true;
        Message = message;
        Data = data;
        Timestamp = DateTime.UtcNow;
    }
}
```

## 禁用特定 Action 的包装

使用 `[NoWrapper]` 特性：

```csharp
[HttpGet("raw")]
[NoWrapper]  // 不包装此方法的返回值
public Product GetRawProduct(int id)
{
    return new Product { Id = id, Name = "Product A" };
}

// 直接返回
{
  "id": 1,
  "name": "Product A"
}
```

## 配置选项

```csharp
public class DataWrapperOptions
{
    // 成功状态码
    public string SuccessCode { get; set; } = "200";
    
    // 成功消息
    public string SuccessMessage { get; set; } = "Success";
    
    // 错误状态码
    public string ErrorCode { get; set; } = "500";
    
    // 错误消息
    public string ErrorMessage { get; set; } = "Error";
    
    // 是否包装空值
    public bool WrapNullValue { get; set; } = true;
}
```

## 最佳实践

### 1. 保持响应格式一致

所有 API 都应使用相同的响应格式，便于客户端统一处理。

### 2. 提供有意义的消息

```csharp
// ✅ 好的做法
return new ApiResponse("200", "Order created successfully", order);

// ❌ 避免
return new ApiResponse("200", "OK", order);
```

### 3. 合理使用 HTTP 状态码

虽然使用统一响应格式，但 HTTP 状态码仍然应该正确设置。

## 小结

MiCake 统一返回：

- 自动包装 Controller 返回值
- 提供一致的响应格式
- 支持自定义响应结构
- 可以禁用特定 Action 的包装

下一步：
- 学习[自定义返回结果](./自定义返回结果.md)深入定制
- 查看[异常](./异常.md)了解错误处理
