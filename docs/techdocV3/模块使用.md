# 模块使用

MiCake 采用模块化设计，应用程序由多个模块组成。模块系统提供了清晰的组织结构和生命周期管理。

## 什么是模块

模块是 MiCake 应用程序的基本组织单元，每个模块可以：

- 注册自己的服务
- 管理自己的生命周期
- 声明对其他模块的依赖
- 配置应用程序功能

## 创建模块

### 基本模块

```csharp
using MiCake.Core.Modularity;

public class MyAppModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        // 注册服务
        context.Services.AddScoped<IMyService, MyService>();
        
        // 自动注册仓储
        context.AutoRegisterRepositories(typeof(MyAppModule).Assembly);
        
        base.ConfigureServices(context);
    }

    public override void OnApplicationInitialization(ModuleInitializationContext context)
    {
        // 应用启动时执行
        var logger = context.ServiceProvider.GetService<ILogger>();
        logger?.LogInformation("MyAppModule initialized");
        
        base.OnApplicationInitialization(context);
    }

    public override void OnApplicationShutdown(ModuleShutdownContext context)
    {
        // 应用关闭时执行
        base.OnApplicationShutdown(context);
    }
}
```

## 模块依赖

使用 `[RelyOn]` 特性声明模块依赖：

```csharp
using MiCake.AspNetCore.Modules;
using MiCake.EntityFrameworkCore.Modules;

[RelyOn(typeof(MiCakeAspNetCoreModule))]
[RelyOn(typeof(MiCakeEntityFrameworkCoreModule))]
public class MyAppModule : MiCakeModule
{
    // MiCake 会确保依赖的模块先初始化
}
```

### 依赖解析顺序

MiCake 自动处理模块依赖的解析和初始化顺序：

```
应用程序启动流程：

1. 扫描入口模块
   MyAppModule
      ↓
2. 解析依赖关系
   MiCakeAspNetCoreModule → MiCakeCoreModule
   MiCakeEntityFrameworkCoreModule → MiCakeCoreModule
   MyAppModule → [依赖的模块]
      ↓
3. 按依赖顺序初始化
   MiCakeCoreModule (最基础)
   MiCakeAspNetCoreModule
   MiCakeEntityFrameworkCoreModule
   MyAppModule (入口模块最后)
```

## 模块生命周期

### ConfigureServices

在此阶段注册服务到 DI 容器：

```csharp
public class OrderModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        // 注册领域服务
        context.Services.AddScoped<IPricingService, PricingService>();
        
        // 注册应用服务
        context.Services.AddScoped<OrderApplicationService>();
        
        // 自动注册仓储
        context.AutoRegisterRepositories(typeof(OrderModule).Assembly);
        
        // 配置选项
        context.Services.Configure<OrderOptions>(options =>
        {
            options.MaxItemsPerOrder = 100;
        });
        
        base.ConfigureServices(context);
    }
}
```

### OnApplicationInitialization

应用启动时执行初始化逻辑：

```csharp
public class DataSeedModule : MiCakeModule
{
    public override void OnApplicationInitialization(ModuleInitializationContext context)
    {
        var dbContext = context.ServiceProvider.GetRequiredService<MyDbContext>();
        
        // 确保数据库已创建
        dbContext.Database.EnsureCreated();
        
        // 数据初始化
        SeedData(dbContext);
        
        base.OnApplicationInitialization(context);
    }
    
    private void SeedData(MyDbContext dbContext)
    {
        if (!dbContext.Users.Any())
        {
            // 添加初始数据
        }
    }
}
```

### OnApplicationShutdown

应用关闭时执行清理逻辑：

```csharp
public class CacheModule : MiCakeModule
{
    public override void OnApplicationShutdown(ModuleShutdownContext context)
    {
        var cacheService = context.ServiceProvider.GetService<ICacheService>();
        cacheService?.Dispose();
        
        base.OnApplicationShutdown(context);
    }
}
```

## 模块组织

### 按功能模块化

```
MyApplication/
├── Modules/
│   ├── OrderModule.cs          // 订单模块
│   ├── PaymentModule.cs        // 支付模块
│   ├── InventoryModule.cs      // 库存模块
│   └── NotificationModule.cs   // 通知模块
├── Domain/
│   ├── Orders/
│   ├── Payments/
│   └── Products/
└── MyAppModule.cs              // 入口模块
```

### 订单模块示例

```csharp
[RelyOn(typeof(PaymentModule))]
[RelyOn(typeof(InventoryModule))]
public class OrderModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        // 注册订单相关服务
        context.Services.AddScoped<IOrderService, OrderService>();
        context.Services.AddScoped<IOrderPricingService, OrderPricingService>();
        
        // 注册订单仓储
        context.AutoRegisterRepositories(typeof(OrderModule).Assembly);
        
        base.ConfigureServices(context);
    }
}
```

## 启动模块

### 在 Startup 中配置

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddControllers();
        
        // 配置 MiCake，指定入口模块
        services.AddMiCakeWithDefault<MyAppModule, MyDbContext>(options =>
        {
            options.AppConfig = app =>
            {
                app.DomainLayerAssemblies = new[] { typeof(MyAppModule).Assembly };
            };
        }).Build();  // 必须调用 Build()
    }
    
    public void Configure(IApplicationBuilder app)
    {
        app.UseRouting();
        
        // 启动 MiCake 模块系统
        app.StartMiCake();
        
        app.UseEndpoints(endpoints =>
        {
            endpoints.MapControllers();
        });
    }
}
```

## 模块配置

### 使用配置文件

```csharp
public class MyAppModule : MiCakeModule
{
    private readonly IConfiguration _configuration;
    
    public MyAppModule(IConfiguration configuration)
    {
        _configuration = configuration;
    }
    
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        // 从配置文件读取设置
        var connectionString = _configuration.GetConnectionString("DefaultConnection");
        
        context.Services.AddDbContext<MyDbContext>(options =>
        {
            options.UseSqlServer(connectionString);
        });
        
        base.ConfigureServices(context);
    }
}
```

### 模块选项

```csharp
public class OrderModuleOptions
{
    public int MaxItemsPerOrder { get; set; } = 100;
    public decimal MinOrderAmount { get; set; } = 1.0m;
}

public class OrderModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        // 配置模块选项
        context.Services.Configure<OrderModuleOptions>(options =>
        {
            options.MaxItemsPerOrder = 200;
            options.MinOrderAmount = 10.0m;
        });
        
        base.ConfigureServices(context);
    }
}

// 使用选项
public class OrderService
{
    private readonly OrderModuleOptions _options;
    
    public OrderService(IOptions<OrderModuleOptions> options)
    {
        _options = options.Value;
    }
    
    public void ValidateOrder(Order order)
    {
        if (order.Items.Count > _options.MaxItemsPerOrder)
            throw new DomainException("Too many items");
    }
}
```

## 最佳实践

### 1. 保持模块独立

```csharp
// ✅ 好的做法 - 模块功能内聚
public class OrderModule : MiCakeModule
{
    // 只包含订单相关的配置
}

public class PaymentModule : MiCakeModule
{
    // 只包含支付相关的配置
}
```

### 2. 明确声明依赖

```csharp
// ✅ 使用 RelyOn 明确依赖
[RelyOn(typeof(OrderModule))]
[RelyOn(typeof(PaymentModule))]
public class CheckoutModule : MiCakeModule
{
}
```

### 3. 避免循环依赖

```csharp
// ❌ 避免循环依赖
[RelyOn(typeof(ModuleB))]
public class ModuleA : MiCakeModule { }

[RelyOn(typeof(ModuleA))]  // 循环依赖！
public class ModuleB : MiCakeModule { }

// ✅ 正确的做法 - 提取共享模块
public class SharedModule : MiCakeModule { }

[RelyOn(typeof(SharedModule))]
public class ModuleA : MiCakeModule { }

[RelyOn(typeof(SharedModule))]
public class ModuleB : MiCakeModule { }
```

## 小结

MiCake 模块系统：

- 继承 `MiCakeModule` 创建模块
- 使用 `[RelyOn]` 声明依赖
- 自动处理依赖解析和初始化顺序
- 提供生命周期钩子
- 支持模块化组织应用程序

下一步：
- 学习[依赖注入](./依赖注入.md)了解服务注册
- 阅读[快速开始](./快速开始.md)查看完整示例
- 查看[核心概念](./核心概念.md)理解模块设计
