# 自动审计

MiCake 提供了自动审计功能，可以自动记录实体的创建时间和修改时间，无需手动维护这些字段。

## 什么是自动审计？

自动审计功能会在实体被创建或修改时，自动设置相应的时间戳字段，帮助您追踪数据的变更历史。

**支持的审计字段：**
- `CreationTime` - 创建时间
- `ModificationTime` - 修改时间（可选）

## 启用审计

### 实现审计接口

#### 只记录创建时间

实现 `IHasCreationTime` 接口：

```csharp
using MiCake.Audit;

public class Product : AggregateRoot<int>, IHasCreationTime
{
    public string Name { get; private set; }
    public decimal Price { get; private set; }
    
    // 自动设置
    public DateTime CreationTime { get; set; }

    private Product() { }

    public static Product Create(string name, decimal price)
    {
        return new Product
        {
            Name = name,
            Price = price
            // CreationTime 会自动设置，无需手动赋值
        };
    }
}
```

#### 记录创建和修改时间

实现 `IHasAudit` 接口：

```csharp
using MiCake.Audit;

public class Order : AggregateRoot<int>, IHasAudit
{
    public string OrderNumber { get; private set; }
    public OrderStatus Status { get; private set; }
    
    // 自动设置
    public DateTime CreationTime { get; set; }
    public DateTime? ModificationTime { get; set; }

    private Order() { }

    public static Order Create(string orderNumber)
    {
        return new Order
        {
            OrderNumber = orderNumber,
            Status = OrderStatus.Draft
            // CreationTime 会自动设置
        };
    }

    public void Confirm()
    {
        Status = OrderStatus.Confirmed;
        // ModificationTime 会在 SaveChangesAsync 时自动更新
    }
}
```

#### 只记录修改时间

实现 `IHasModificationTime` 接口：

```csharp
using MiCake.Audit;

public class UserProfile : Entity<int>, IHasModificationTime
{
    public string Bio { get; private set; }
    public string Avatar { get; private set; }
    
    // 自动设置
    public DateTime? ModificationTime { get; set; }

    public void UpdateProfile(string bio, string avatar)
    {
        Bio = bio;
        Avatar = avatar;
        // ModificationTime 会自动更新
    }
}
```

## 审计工作原理

审计功能在实体保存到数据库之前自动执行：

```csharp
[HttpPost]
public async Task<IActionResult> CreateProduct([FromBody] CreateProductDto dto)
{
    // 1. 创建实体
    var product = Product.Create(dto.Name, dto.Price);
    
    // 此时 product.CreationTime 还未设置
    Console.WriteLine(product.CreationTime); // DateTime.MinValue

    // 2. 添加到仓储
    await _productRepository.AddAsync(product);
    
    // 3. 保存更改
    await _productRepository.SaveChangesAsync();
    
    // 此时 product.CreationTime 已自动设置为当前时间
    Console.WriteLine(product.CreationTime); // 例如：2024-01-15 10:30:00

    return Ok(product.Id);
}
```

### 更新场景

```csharp
[HttpPut("{id}")]
public async Task<IActionResult> UpdateOrder(int id, [FromBody] UpdateOrderDto dto)
{
    // 1. 查询实体
    var order = await _orderRepository.FindAsync(id);
    
    Console.WriteLine(order.CreationTime);      // 创建时的时间，不会改变
    Console.WriteLine(order.ModificationTime);  // null 或上次修改时间

    // 2. 修改实体
    order.UpdateShippingAddress(dto.ShippingAddress);
    
    // 3. 保存更改
    await _orderRepository.SaveChangesAsync();
    
    // 此时 order.ModificationTime 已自动更新为当前时间
    Console.WriteLine(order.ModificationTime);  // 例如：2024-01-15 10:35:00

    return Ok();
}
```

## 审计字段特点

### CreationTime

- **只设置一次**：在实体首次保存时设置
- **不会更新**：后续更新不会改变创建时间
- **必需字段**：通常定义为 `DateTime`（非可空）

### ModificationTime

- **可选字段**：通常定义为 `DateTime?`（可空）
- **首次为 null**：创建时不设置
- **更新时设置**：每次更新实体时都会更新为当前时间

## 配置审计

### 启用审计功能

在模块中启用审计：

```csharp
using MiCake.Core.Modularity;

public class MyModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        // 启用审计功能
        context.Services.AddAudit();

        base.ConfigureServices(context);
    }
}
```

### 配置审计选项

```csharp
using MiCake.Audit;

public class MyModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        context.Services.Configure<MiCakeAuditOptions>(options =>
        {
            // 配置创建时间提供器
            options.CreationTimeProvider = () => DateTime.UtcNow;
            
            // 配置修改时间提供器
            options.ModificationTimeProvider = () => DateTime.UtcNow;
        });

        base.ConfigureServices(context);
    }
}
```

## 使用场景

### 数据审计

追踪数据的创建和修改历史：

```csharp
public class Article : AggregateRoot<int>, IHasAudit
{
    public string Title { get; private set; }
    public string Content { get; private set; }
    
    public DateTime CreationTime { get; set; }
    public DateTime? ModificationTime { get; set; }

    // 查询最近修改的文章
    public static async Task<List<Article>> GetRecentlyModified(IRepository<Article, int> repository)
    {
        return await repository.Query()
            .Where(a => a.ModificationTime != null)
            .OrderByDescending(a => a.ModificationTime)
            .Take(10)
            .ToListAsync();
    }
}
```

### 版本控制

结合修改时间实现简单的版本控制：

```csharp
public class Document : AggregateRoot<int>, IHasAudit
{
    public string Title { get; private set; }
    public string Content { get; private set; }
    public int Version { get; private set; }
    
    public DateTime CreationTime { get; set; }
    public DateTime? ModificationTime { get; set; }

    public void Update(string title, string content)
    {
        Title = title;
        Content = content;
        Version++;
        // ModificationTime 会自动更新
    }
}
```

### 显示创建/修改信息

在 DTO 中包含审计信息：

```csharp
public class ArticleDto
{
    public int Id { get; set; }
    public string Title { get; set; }
    public string Content { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? LastModifiedAt { get; set; }
}

public class ArticleService
{
    public ArticleDto MapToDto(Article article)
    {
        return new ArticleDto
        {
            Id = article.Id,
            Title = article.Title,
            Content = article.Content,
            CreatedAt = article.CreationTime,
            LastModifiedAt = article.ModificationTime
        };
    }
}
```

## 审计最佳实践

### 1. 对重要实体启用审计

```csharp
// ✅ 重要实体启用审计
public class Order : AggregateRoot<int>, IHasAudit
{
    public DateTime CreationTime { get; set; }
    public DateTime? ModificationTime { get; set; }
}

public class OrderItem : Entity<int>, IHasAudit
{
    public DateTime CreationTime { get; set; }
    public DateTime? ModificationTime { get; set; }
}
```

### 2. 使用 UTC 时间

```csharp
// ✅ 正确：使用 UTC 时间
context.Services.Configure<MiCakeAuditOptions>(options =>
{
    options.CreationTimeProvider = () => DateTime.UtcNow;
    options.ModificationTimeProvider = () => DateTime.UtcNow;
});

// ❌ 不推荐：使用本地时间（会因时区问题产生困扰）
options.CreationTimeProvider = () => DateTime.Now;
```

### 3. 只读属性设为 set

虽然这些字段由系统自动设置，但仍需要 `set` 访问器（供 EF Core 使用）：

```csharp
// ✅ 正确
public DateTime CreationTime { get; set; }
public DateTime? ModificationTime { get; set; }

// ❌ 错误：EF Core 无法设置
public DateTime CreationTime { get; }
public DateTime? ModificationTime { get; }
```

### 4. 在数据库中建立索引

对于需要按时间查询的场景，建议在审计字段上建立索引：

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);

    modelBuilder.Entity<Article>(entity =>
    {
        entity.ToTable("Articles");
        
        // 在审计字段上建立索引
        entity.HasIndex(e => e.CreationTime);
        entity.HasIndex(e => e.ModificationTime);
    });
}
```

## 审计信息查询

### 按创建时间查询

```csharp
// 查询今天创建的订单
public async Task<List<Order>> GetTodayOrders()
{
    var today = DateTime.UtcNow.Date;
    var tomorrow = today.AddDays(1);

    return await _orderRepository.Query()
        .Where(o => o.CreationTime >= today && o.CreationTime < tomorrow)
        .ToListAsync();
}

// 查询最近 7 天创建的订单
public async Task<List<Order>> GetRecentOrders()
{
    var sevenDaysAgo = DateTime.UtcNow.AddDays(-7);

    return await _orderRepository.Query()
        .Where(o => o.CreationTime >= sevenDaysAgo)
        .OrderByDescending(o => o.CreationTime)
        .ToListAsync();
}
```

### 按修改时间查询

```csharp
// 查询最近更新的文章
public async Task<List<Article>> GetRecentlyUpdatedArticles()
{
    return await _articleRepository.Query()
        .Where(a => a.ModificationTime != null)
        .OrderByDescending(a => a.ModificationTime)
        .Take(20)
        .ToListAsync();
}

// 查询长时间未更新的记录
public async Task<List<Article>> GetStaleArticles()
{
    var sixMonthsAgo = DateTime.UtcNow.AddMonths(-6);

    return await _articleRepository.Query()
        .Where(a => a.ModificationTime < sixMonthsAgo || 
                   (a.ModificationTime == null && a.CreationTime < sixMonthsAgo))
        .ToListAsync();
}
```

## 扩展审计功能

如果需要更复杂的审计功能（如记录操作人），可以扩展审计接口：

```csharp
// 自定义审计接口
public interface IHasFullAudit : IHasAudit
{
    int? CreatorId { get; set; }
    int? LastModifierId { get; set; }
}

// 实现
public class Order : AggregateRoot<int>, IHasFullAudit
{
    public DateTime CreationTime { get; set; }
    public DateTime? ModificationTime { get; set; }
    public int? CreatorId { get; set; }
    public int? LastModifierId { get; set; }
}

// 自定义审计提供器
public class CustomAuditProvider : IAuditProvider
{
    private readonly ICurrentUser _currentUser;

    public void SetAuditInfo(object entity)
    {
        if (entity is IHasFullAudit fullAudit)
        {
            if (fullAudit.CreationTime == default)
            {
                fullAudit.CreationTime = DateTime.UtcNow;
                fullAudit.CreatorId = _currentUser.Id;
            }
            else
            {
                fullAudit.ModificationTime = DateTime.UtcNow;
                fullAudit.LastModifierId = _currentUser.Id;
            }
        }
    }
}
```

## 注意事项

1. **UTC 时间**：建议使用 UTC 时间而不是本地时间
2. **数据库索引**：对常用查询字段建立索引
3. **只读显示**：在前端显示时转换为用户本地时间
4. **EF Core 要求**：审计字段必须有 `set` 访问器
5. **自动设置**：不要在代码中手动设置审计字段

## 下一步

- 了解[软删除支持](./软删除支持.md)
- 学习[聚合根](./聚合根.md)
- 探索[仓储](./仓储.md)的使用
