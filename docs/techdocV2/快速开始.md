# 快速开始

本指南将帮助您在 ASP.NET Core 项目中快速集成 MiCake 框架。

## 环境准备

确保您的开发环境满足以下要求：

- .NET Core 5.0 或更高版本
- Visual Studio 2019 或更高版本（或其他支持 .NET Core 的 IDE）

## 安装 NuGet 包

在您的 ASP.NET Core 项目中，通过 NuGet 安装 MiCake 启动包：

```powershell
Install-Package MiCake.AspNetCore.Start
```

或者使用 .NET CLI：

```bash
dotnet add package MiCake.AspNetCore.Start
```

该包会自动引入所有必需的依赖项。

## 创建入口模块

创建一个继承自 `MiCakeModule` 的入口模块类：

```csharp
using MiCake.AspNetCore.Modules;
using MiCake.Core.Modularity;
using Microsoft.Extensions.DependencyInjection;

[RelyOn(typeof(MiCakeAspNetCoreModule))]
public class MyAppModule : MiCakeModule
{
    public override void ConfigureServices(ModuleConfigServiceContext context)
    {
        // 自动注册当前程序集中的仓储
        context.AutoRegisterRepositories(typeof(MyAppModule).Assembly);

        base.ConfigureServices(context);
    }
}
```

**关键点说明：**

- `[RelyOn]` 特性声明模块依赖关系
- `ConfigureServices` 方法用于配置服务
- `AutoRegisterRepositories` 自动注册领域仓储

## 配置 Startup

在 `Startup.cs` 中配置 MiCake：

```csharp
using MiCake.Core;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;

public class Startup
{
    public IConfiguration Configuration { get; }

    public Startup(IConfiguration configuration)
    {
        Configuration = configuration;
    }

    public void ConfigureServices(IServiceCollection services)
    {
        services.AddControllers();

        // 配置 Entity Framework Core（如果使用）
        services.AddDbContext<MyDbContext>(options =>
        {
            options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection"));
        });

        // 注册并配置 MiCake
        services.AddMiCakeWithDefault<MyAppModule, MyDbContext>(options =>
        {
            // 应用配置
            options.AppConfig = app =>
            {
                // 可以在这里配置 MiCake 应用选项
            };

            // ASP.NET Core 配置
            options.AspNetConfig = asp =>
            {
                // 配置数据包装器、异常处理等
            };
        }).Build();
    }

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        if (env.IsDevelopment())
        {
            app.UseDeveloperExceptionPage();
        }

        app.UseRouting();
        
        // 启动 MiCake（必须在 UseEndpoints 之前）
        app.StartMiCake();

        app.UseEndpoints(endpoints =>
        {
            endpoints.MapControllers();
        });
    }
}
```

**重要提示：**

- `AddMiCakeWithDefault` 注册 MiCake 框架并配置默认选项
- `StartMiCake()` 必须在 `UseEndpoints()` 之前调用
- 第一个泛型参数是入口模块类型，第二个是 DbContext 类型

## 创建 DbContext

如果使用 Entity Framework Core，创建继承自 `MiCakeDbContext` 的数据库上下文：

```csharp
using MiCake.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

public class MyDbContext : MiCakeDbContext
{
    public MyDbContext(DbContextOptions<MyDbContext> options)
        : base(options)
    {
    }

    // 定义 DbSet
    public DbSet<MyEntity> MyEntities { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // 必须调用基类方法，以配置 DDD 实体
        base.OnModelCreating(modelBuilder);

        // 您的额外配置
        modelBuilder.Entity<MyEntity>(entity =>
        {
            entity.ToTable("MyEntities");
            // 其他配置...
        });
    }
}
```

**关键点：**

- 必须继承 `MiCakeDbContext`
- 必须调用 `base.OnModelCreating(modelBuilder)`

## 创建领域对象

创建一个简单的聚合根：

```csharp
using MiCake.DDD.Domain;

public class Book : AggregateRoot<int>
{
    public string Title { get; private set; }
    public string Author { get; private set; }
    public decimal Price { get; private set; }

    // 私有构造函数，用于 EF Core
    private Book() { }

    // 工厂方法
    public static Book Create(string title, string author, decimal price)
    {
        var book = new Book
        {
            Title = title,
            Author = author,
            Price = price
        };

        // 可以触发领域事件
        book.RaiseDomainEvent(new BookCreatedEvent(book.Id, title));

        return book;
    }

    public void ChangePrice(decimal newPrice)
    {
        if (newPrice <= 0)
            throw new DomainException("价格必须大于零");

        Price = newPrice;
        RaiseDomainEvent(new BookPriceChangedEvent(Id, newPrice));
    }
}
```

## 使用仓储

在控制器或应用服务中使用仓储：

```csharp
using MiCake.DDD.Domain;
using Microsoft.AspNetCore.Mvc;
using System.Threading.Tasks;

[ApiController]
[Route("api/[controller]")]
public class BookController : ControllerBase
{
    private readonly IRepository<Book, int> _bookRepository;

    public BookController(IRepository<Book, int> bookRepository)
    {
        _bookRepository = bookRepository;
    }

    [HttpPost]
    public async Task<IActionResult> CreateBook([FromBody] CreateBookDto dto)
    {
        var book = Book.Create(dto.Title, dto.Author, dto.Price);
        
        await _bookRepository.AddAsync(book);
        await _bookRepository.SaveChangesAsync();

        return Ok(book.Id);
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> GetBook(int id)
    {
        var book = await _bookRepository.FindAsync(id);
        if (book == null)
            return NotFound();

        return Ok(book);
    }

    [HttpPut("{id}/price")]
    public async Task<IActionResult> ChangePrice(int id, [FromBody] decimal newPrice)
    {
        var book = await _bookRepository.FindAsync(id);
        if (book == null)
            return NotFound();

        book.ChangePrice(newPrice);
        await _bookRepository.SaveChangesAsync();

        return Ok();
    }
}
```

## 运行应用

现在您可以运行应用程序了：

```bash
dotnet run
```

您的应用程序已经集成了 MiCake，并可以使用其提供的 DDD 功能。

## 验证集成

访问您的 API 端点，验证功能是否正常工作。如果启用了数据包装器（默认启用），您的 API 响应会自动包装为统一格式：

```json
{
  "code": "200",
  "message": "Success",
  "data": {
    "id": 1,
    "title": "示例书籍"
  }
}
```

## 下一步

- 了解[核心概念](./核心概念.md)
- 学习如何使用[实体和聚合根](./实体.md)
- 探索[领域事件](./领域事件.md)机制
- 配置[统一返回](./统一返回.md)格式
